#!/usr/bin/env bash

set -eux

# Upgrade to latest
sudo apt-get update && sudo apt-get -y full-upgrade

# mozc
sudo apt-get install -y ibus-mozc
set +e
ibus restart
gsettings set org.gnome.desktop.input-sources sources "[('ibus', 'mozc-jp')]"
set -e

# git
sudo apt-get install -y git

# pyenv
sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
git clone https://github.com/pyenv/pyenv.git ~/.pyenv
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init -)"' >> ~/.bashrc
HOMEPATH=~
export PATH="$HOMEPATH/.pyenv/bin:$HOMEPATH/.nodenv/bin:$PATH"
set +e
eval "$(pyenv init -)"
set -e
python3_ver="3.9.15"
python2_ver="2.7.18"
pyenv install $python3_ver
pyenv install $python2_ver
pyenv global $python3_ver $python2_ver

# pip
pip install fortls fprettify pytest black flake8

# nodenv
git clone https://github.com/nodenv/nodenv.git ~/.nodenv
echo 'export PATH="$HOME/.nodenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(nodenv init -)"' >> ~/.bashrc
set +e
eval "$(nodenv init -)"
set -e
mkdir -p "$(nodenv root)"/plugins
git clone https://github.com/nodenv/node-build.git "$(nodenv root)"/plugins/node-build
node_ver="16.16.0"
nodenv install $node_ver
nodenv global $node_ver

# neovim
sudo apt-get install -y neovim
git clone https://github.com/kohei-noda-qcrg/dotfiles.git ~/dotfiles
mkdir -p ~/.config/nvim
cp ~/dotfiles/nvim/init.vim ~/.config/nvim/init.vim

# git settings
mkdir -p ~/.config/git
cp ~/dotfiles/git/* ~/.config/git
echo 'source "$HOME/.config/git/git-completion.bash"' >> ~/.bashrc
echo 'source "$HOME/.config/git/git-prompt.sh"' >> ~/.bashrc
echo 'export GIT_PS1_SHOWDIRTYSTATE=1' >> ~/.bashrc
echo "export PS1='\[\033[01;32m\]\u@\h\[\033[01;34m\] \w\[\033[01;33m\]\$(__git_ps1)\[\033[01;34m\] \$\[\033[00m\] '" >> ~/.bashrc
git config --global init.defaultBranch main

# Environment Modules
sudo apt-get install -y environment-modules
echo ". /usr/share/modules/init/bash" >> ~/.bashrc

wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
sudo apt-get update
sudo apt-get install -y intel-oneapi-compiler-fortran intel-oneapi-openmp intel-oneapi-mpi intel-oneapi-mpi-devel intel-oneapi-mkl
sudo /opt/intel/oneapi/modulefiles-setup.sh 
echo 'module use "/opt/intel/oneapi/modulefiles"' >> ~/.bashrc
